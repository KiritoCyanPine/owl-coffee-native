name: Xcode - Build and Analyze

on:
  push:
    branches: ['main']
  workflow_dispatch:

jobs:
  build:
    name: Build and analyse default scheme using xcodebuild command
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4.0'

      - name: Build
        env:
          scheme: ${{ 'default' }}
        run: |
          make clean
          make app

      - name: Check File Exist
        id: check_dist
        uses: andstor/file-existence-action@v3
        with:
          files: 'build/Release/Owl Coffee.app'

      - name: Veirfy Build File Exist
        if: steps.check_files.outputs.files_exists == 'false'
        # Only runs if all of the files exists
        run: |
          echo "File does not Exist!"
          exit 1

      - name: Locate .app bundle
        run: |
          # Set the path to your bundle, or discover it
          export APP_BUNDLE=$(find . -name "build/Release/Owl Coffee.app" -type d | head -n 1)
          echo "BUNDLE_PATH=$APP_BUNDLE" >> $GITHUB_ENV

      - name: Check bundle structure
        run: |
          tree "$BUNDLE_PATH"
          test -f "$BUNDLE_PATH/Contents/Info.plist"
          test -d "$BUNDLE_PATH/Contents/MacOS"
          test -d "$BUNDLE_PATH/Contents/Resources"

      - name: Validate Info.plist
        run: plutil -lint "$BUNDLE_PATH/Contents/Info.plist"

      - name: Check executable permissions
        run: |
          EXEC=$(defaults read "$BUNDLE_PATH/Contents/Info" CFBundleExecutable)
          ls -l "$BUNDLE_PATH/Contents/MacOS/$EXEC"
          test -x "$BUNDLE_PATH/Contents/MacOS/$EXEC"

      - name: Open App and Spy on Process
        run: |
          open "$BUNDLE_PATH"
          sleep 5 # give it a moment to launch

          # Run lsof and grep for "Owl Coffee.app"
          output="$(lsof | grep "$BUNDLE_PATH")"
          if [ -z "$output" ]; then
            echo "Owl Coffee.app is NOT running."
            exit 1
          else
            echo "Owl Coffee.app is running:"
          fi

      - name: Test Application handling
        run: |
          echo "Emulate Command+D :  should start caffeination with Display"
          osascript -e 'tell application "System Events" to keystroke "d" using command
          sleep 5 # give it a moment to launch

          output="$(lsof | grep "caffeinate")"
          if [ -z "$output" ]; then
            echo "'caffeination' is NOT running."
            exit 1
          else
            echo "caffeination is running."
          fi

          echo "Emulate Command+A :  should Stop caffeination"
          osascript -e 'tell application "System Events" to keystroke "a" using command
          sleep 5 # give it a moment to launch

          output="$(lsof | grep "caffeinate")"
          if [ -z "$output" ]; then
            echo "'caffeination' is NOT running."
          else
            echo "caffeination is still running."
            exit 1
          fi

          echo "Emulate Command+C :  should start standard caffeination"
          osascript -e 'tell application "System Events" to keystroke "c" using command
          sleep 5 # give it a moment to launch

          output="$(lsof | grep "caffeinate")"
          if [ -z "$output" ]; then
            echo "'caffeination' is NOT running."
            exit 1
          else
            echo "caffeination is running."
          fi

          osascript -e 'tell application "Owl Coffee" to quit'
          sleep 5
          output="$(lsof | grep "caffeinate")"
          if [ -z "$output" ]; then
            echo "'caffeination' is NOT running."
          else
            echo "caffeination is still running."
            exit 1
          fi

      # - name: Gatekeeper assessment
      #   run: spctl --assess --type execute --verbose=4 "$BUNDLE_PATH"
